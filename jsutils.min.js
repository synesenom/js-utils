var Help={_isInit:false,_isOn:false,_width:400,_height:320,_padding:20,_style:{help:{position:"fixed",width:"100%",height:"100%",top:"0px",left:"0px","background-color":"rgba(255, 255, 255, 0.9)",display:"none",opacity:0},box:{position:"absolute",top:"50%",left:"50%",width:"400px",height:"320px",padding:"20px","margin-left":"-220px","margin-top":"-170px","font-family":"inherit","font-size":"11pt",color:"black","text-align":"justify",border:"1px solid rgba(0, 0, 0, 0.1)","border-radius":2,"box-shadow":"1px 1px 2px gray","background-color":"rgba(255, 255, 255, 0.5)"},content:{position:"relative"}},_box:null,_content:null,init:function(){if(!this._isInit){this._isInit=true;var helpElem=d3.select("body").append("div").attr("id","help").style(Help._style.help);this._box=helpElem.append("div").style(Help._style.box);this._content=this._box.append("div").attr("class","content").style(Help._style.content);d3.select("body").on("keydown",function(){switch(d3.event.which){case 72:if(Help.on())Help.off();break;case 27:Help.off();break}});d3.select("#help").on("click",function(){Help.off()})}},width:function(width){this.init();this._width=width;this._style.box.width=width+"px";this._style.box["margin-left"]=-width/2-this._padding+"px";this._box.style(Help._style.box);return this},height:function(height){this.init();this._height=height;this._style.box.height=height+"px";this._style.box["margin-top"]=-height/2-this._padding+"px";this._box.style(Help._style.box);return this},padding:function(padding){this.init();this._padding=padding;this._style.box.padding=padding+"px";this._style.box["margin-left"]=-this._width/2-padding+"px";this._style.box["margin-top"]=-this._height/2-padding+"px";this._box.style(Help._style.box);return this},content:function(content){this.init();this._content.html(content);return this},on:function(){if(!this._isOn){this._isOn=true;d3.select("#help").style("display","block").transition().duration(500).style("opacity",1);return false}else return true},off:function(){this._isOn=false;d3.select("#help").transition().duration(500).style("opacity",0).each("end",function(){d3.select("#help").style("display","none")})},is:function(){return this._isOn}};var dnd={css:{overlay:{display:"none",position:"fixed",width:"100%",height:"100%","background-color":"rgba(255, 255, 255, 0.9)","font-family":"sans-serif","font-size":"20pt","font-weight":"200",color:"#3399ff"},message:{position:"absolute",top:"50%",left:"50%",width:"300px",height:"80px","margin-left":"-150px","margin-top":"-40px","text-align":"center"},progressBar:{position:"absolute",top:"50%",left:"50%",width:"0px",height:"1px","background-color":"#3399ff","margin-left":"-125px"}},overlay:null,message:null,progressBar:null,lastTarget:null,init:function(callback,style){var dnd=this;dnd.overlay=d3.select("body").append("div").attr("class","dnd").style(dnd.css.overlay);if(style&&style.overlay)dnd.overlay.style(style.overlay);dnd.message=dnd.overlay.append("div").attr("class","message").style(dnd.css.message);dnd.progressBar=dnd.overlay.append("div").attr("class","progress-bar").style(dnd.css.progressBar);d3.select(window).on("dragenter",function(){var e=d3.event;e.preventDefault();e.stopPropagation();dnd.lastTarget=e.target;dnd.overlay.style({display:"block",opacity:1});dnd.message.text("Drop file to upload");dnd.progressBar.style("width","0px")});d3.select(window).on("dragover",function(){var e=d3.event;e.preventDefault();e.stopPropagation();dnd.lastTarget=e.target});d3.select(window).on("dragleave",function(){var e=d3.event;e.preventDefault();e.stopPropagation();if(e.target===dnd.lastTarget){dnd.overlay.style("display","none");dnd.message.text("")}});d3.select(window).on("drop",function(){var e=d3.event;e.preventDefault();e.stopPropagation();if(e.target===dnd.lastTarget){var filename=e.dataTransfer.files[0].name;reader=new FileReader;reader.readAsText(e.dataTransfer.files[0]);reader.onprogress=function(e){if(e.lengthComputable){var percentLoaded=Math.round(e.loaded/e.total*100);if(percentLoaded<100)dnd.progressBar.style("width",percentLoaded*2.5+"px")}};reader.onloadstart=function(e){dnd.message.text("Reading file")};reader.onload=function(e){dnd.progressBar.style("width","0px");dnd.message.text("Done!");dnd.overlay.transition().duration(1e3).style("opacity",0).each("end",function(){d3.select(this).style("display","none")});callback(reader.result,filename)}}})}};var dl={junk:[],tmpId:function(){var id="";var chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<32;i++)id+=chars.charAt(Math.floor(Math.random()*chars.length));return id},getOptions:function(svgElem,options){var svgW=svgElem.attr("width");var svgH=svgElem.attr("height");var m={canvas:{w:svgW,h:svgH},scale:{w:1,h:1}};if(options.width&&options.height){m.canvas.w=options.width;m.scale.w=m.canvas.w/svgW;m.canvas.h=options.height;m.scale.h=m.canvas.h/svgH}else if(options.width){m.canvas.w=options.width;m.scale.w=m.canvas.w/svgW;m.canvas.h=m.scale.w*svgH;m.scale.h=m.scale.w}else if(options.height){m.canvas.h=options.height;m.scale.h=m.canvas.h/svgH;m.canvas.w=scaleH*svgW;m.scale.w=m.scale.h}return m},add:function(elemType){var j=d3.select("body").append(elemType);this.junk.push(j);return j},clean:function(){if(this.junk){this.junk.forEach(function(j){j.remove()})}},png:function(selector,filename,options){var pdl=this;var svgElem=d3.select(selector);var metrics=this.getOptions(svgElem,options);var id="dl-png-"+this.tmpId();var canvas=this.add("canvas").attr("id",id).attr("width",metrics.canvas.w).attr("height",metrics.canvas.h).style("display","none").node(0);var context=canvas.getContext("2d");context.scale(metrics.scale.w,metrics.scale.h);var html=d3.select("svg").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML;var imgsrc="data:image/svg+xml;base64,"+btoa(html);var image=new Image;image.src=imgsrc;image.onload=function(){context.drawImage(image,0,0);var canvasData=canvas.toDataURL("image/png");var byteString=atob(document.querySelector("#"+id).toDataURL().replace(/^data:image\/(png|jpg);base64,/,""));var ab=new ArrayBuffer(byteString.length);var ia=new Uint8Array(ab);for(var i=0;i<byteString.length;i++)ia[i]=byteString.charCodeAt(i);var dataView=new DataView(ab);var blob=new Blob([dataView],{type:"image/png"});var DOMURL=self.URL||self.webkitURL||self;var newurl=DOMURL.createObjectURL(blob);var a=document.createElement("a");a.download=filename;a.href=canvasData;a.click();pdl.clean()}}};